<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å¤¢å¹»èœå–®</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg-color: #fcfcfc; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 120px; }
        .brand-header { position: sticky; top: 0; background: white; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; padding: 10px 0; }
        
        /* åˆ†é¡é¸å–®æ¨£å¼ */
        .category-nav { display: flex; gap: 10px; overflow-x: auto; padding: 10px; background: white; white-space: nowrap; border-bottom: 1px solid #eee; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--primary-pink); background: white; color: var(--primary-pink); font-weight: bold; cursor: pointer; }
        .cat-btn.active { background: var(--primary-pink); color: white; }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; }
        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .food-info { padding: 10px; flex-grow: 1; }
        .note-input { width: 100%; border: 1px solid #eee; border-radius: 4px; padding: 5px; margin-top: 5px; font-size: 12px; box-sizing: border-box; }
        
        .cart-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #333; color: white; border-radius: 15px; padding: 15px; z-index: 1000; box-sizing: border-box; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 90%; max-width: 380px; border-radius: 20px; padding: 25px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="brand-header">
        <div style="font-size: 20px; font-weight: bold; color: var(--primary-pink);">BlingOrder âœ¨</div>
        <div id="category-list" class="category-nav">
            <button class="cat-btn active" onclick="filterCategory('å…¨éƒ¨')">å…¨éƒ¨</button>
        </div>
    </div>

    <div class="menu-grid" id="menu-list"></div>

    <div class="cart-bar" id="cart-bar" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>ğŸ›’ <span id="cart-count">0</span> é … | $<span id="cart-total">0</span></div>
            <button onclick="showConfirmModal()" style="background:var(--primary-pink); border:none; color:white; padding:8px 15px; border-radius:20px; font-weight:bold;">ç¢ºèªä¸‹å–®</button>
        </div>
    </div>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 style="text-align:center; color:var(--primary-pink);">ç¢ºèªè¨‚å–®å…§å®¹</h3>
            <div id="confirm-list" style="margin: 15px 0; max-height: 200px; overflow-y: auto;"></div>
            <div style="text-align: right; font-weight: bold; font-size: 20px; border-top: 1px solid #eee; padding-top:10px;">ç¸½è¨ˆï¼š$<span id="confirm-total">0</span></div>
            <button onclick="finalSubmit()" style="width:100%; padding:15px; background:var(--primary-pink); color:white; border:none; border-radius:12px; font-weight:bold; font-size:18px; margin-top:15px;">ç¢ºå®šé€å‡º</button>
            <button onclick="closeModal()" style="width:100%; padding:12px; background:#eee; color:#666; border:none; border-radius:12px; margin-top:10px;">è¿”å›ä¿®æ”¹</button>
        </div>
    </div>

<script>
    const firebaseConfig = { /* æ‚¨çš„ Firebase é…ç½® */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    const tableNum = urlParams.get('table') || "M1";
    let cart = [];
    let allItems = [];

    // è¼‰å…¥èœå–®ä¸¦å‹•æ…‹ç”Ÿæˆåˆ†é¡
    db.ref('menu').on('value', snap => {
        allItems = [];
        const categories = new Set();
        const list = document.getElementById('menu-list');
        const catNav = document.getElementById('category-list');
        
        snap.forEach(child => {
            let item = child.val();
            item.id = child.key;
            allItems.push(item);
            if(item.category) categories.add(item.category);
        });

        // æ¸²æŸ“åˆ†é¡æŒ‰éˆ•
        catNav.innerHTML = `<button class="cat-btn active" onclick="filterCategory('å…¨éƒ¨')">å…¨éƒ¨</button>`;
        categories.forEach(cat => {
            catNav.innerHTML += `<button class="cat-btn" onclick="filterCategory('${cat}')">${cat}</button>`;
        });

        renderMenu(allItems);
    });

    function renderMenu(items) {
        const list = document.getElementById('menu-list');
        list.innerHTML = "";
        items.forEach(item => {
            if(item.isSoldOut) return;
            list.innerHTML += `
                <div class="food-card">
                    <img src="${item.image || 'https://placehold.co/300'}" style="width:100%; aspect-ratio:1/1; object-fit:cover;">
                    <div class="food-info">
                        <div style="font-weight:bold;">${item.name}</div>
                        <div style="color:var(--primary-pink);">$${item.price}</div>
                        <input type="text" id="note-${item.id}" class="note-input" placeholder="â• å‚™è¨» (å¦‚ï¼šå»å†°)">
                        <button onclick="addToCart('${item.id}', '${item.name}', ${item.price})" style="width:100%; background:var(--primary-pink); color:white; border:none; border-radius:8px; padding:8px; margin-top:8px; font-weight:bold;">åŠ å…¥</button>
                    </div>
                </div>`;
        });
    }

    function filterCategory(cat) {
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        if(cat === 'å…¨éƒ¨') renderMenu(allItems);
        else renderMenu(allItems.filter(i => i.category === cat));
    }

    function addToCart(id, name, price) {
        const note = document.getElementById(`note-${id}`).value;
        cart.push({ name, price, note });
        document.getElementById(`note-${id}`).value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
        renderCart();
    }

    function renderCart() {
        const bar = document.getElementById('cart-bar');
        if(cart.length === 0) { bar.style.display='none'; return; }
        bar.style.display='block';
        document.getElementById('cart-count').innerText = cart.length;
        document.getElementById('cart-total').innerText = cart.reduce((s,i)=>s+parseInt(i.price),0);
    }

    function showConfirmModal() {
        const list = document.getElementById('confirm-list');
        list.innerHTML = cart.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span>${i.name} <small style="color:#999;">${i.note ? '('+i.note+')' : ''}</small></span>
            <span>$${i.price}</span>
        </div>`).join('');
        document.getElementById('confirm-total').innerText = document.getElementById('cart-total').innerText;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function finalSubmit() {
        const orderData = {
            table: tableNum,
            items: cart.map(i => i.note ? `${i.name}(${i.note})` : i.name),
            total: document.getElementById('confirm-total').innerText,
            status: "å¾…è™•ç†",
            time: new Date().toLocaleTimeString()
        };
        db.ref('orders/' + Date.now()).set(orderData).then(() => {
            alert("è¨‚å–®å·²é€å‡ºï¼");
            location.reload();
        });
    }
    function closeModal() { document.getElementById('confirmModal').style.display = 'none'; }
</script>
</body>
</html>