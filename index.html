<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å¤¢å¹»èœå–®</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg-color: #fcfcfc; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 120px; }
        
        .brand-header { position: sticky; top: 0; background: white; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; padding: 15px 0; }
        .brand-name { font-size: 22px; font-weight: bold; color: var(--primary-pink); }

        .category-nav { display: flex; gap: 10px; overflow-x: auto; padding: 10px; background: white; white-space: nowrap; border-bottom: 1px solid #eee; }
        .cat-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--primary-pink); background: white; color: var(--primary-pink); font-weight: bold; cursor: pointer; }
        .cat-btn.active { background: var(--primary-pink); color: white; }

        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px; }
        .food-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .food-img-box { width: 100%; aspect-ratio: 1/1; background: #f0f0f0; }
        .food-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .food-info { padding: 10px; display: flex; flex-direction: column; flex-grow: 1; }
        .food-name { font-weight: bold; font-size: 15px; }
        .staff-note { color: #ff4d4d; font-size: 12px; font-weight: bold; margin-top: 4px; }
        .food-price { color: var(--primary-pink); font-weight: bold; margin: 5px 0; }

        /* é™„åŠ é¸é …æ¨£å¼ */
        .addon-group { display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0; }
        .addon-chip { 
            font-size: 11px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 15px; 
            cursor: pointer; background: white; color: #666; transition: 0.2s;
        }
        .addon-chip.selected { background: var(--primary-pink); color: white; border-color: var(--primary-pink); }

        .btn-add { background: var(--primary-pink); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: auto; }

        .cart-bar { position: fixed; bottom: 20px; left: 5%; width: 90%; background: #333; color: white; border-radius: 15px; padding: 15px; box-sizing: border-box; z-index: 1000; display: none; }
    </style>
</head>
<body>

    <div class="brand-header">
        <div class="brand-name">BlingOrder âœ¨</div>
        <div class="category-nav" id="category-nav">
            <button class="cat-btn active" onclick="filterCategory('å…¨éƒ¨')">å…¨éƒ¨é …ç›®</button>
        </div>
    </div>

    <div class="menu-grid" id="menu-list"></div>

    <div class="cart-bar" id="cart-bar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>ğŸ›’ <span id="cart-count">0</span> é … | <span style="color:var(--primary-pink); font-weight:bold;">$<span id="cart-total">0</span></span></div>
            <button onclick="submitOrder()" style="background:var(--primary-pink); color:white; border:none; padding:8px 15px; border-radius:15px; font-weight:bold;">é€å‡ºè¨‚å–®</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tableNum = new URLSearchParams(window.location.search).get('table') || "M1";
    let allItems = [];
    let cart = [];
    let currentSelections = {}; // ç´€éŒ„å„é¤é»é¸ä¸­çš„é¸é …

    db.ref('menu').on('value', snap => {
        allItems = [];
        const categories = new Set();
        snap.forEach(child => {
            const item = child.val();
            item.id = child.key;
            allItems.push(item);
            if(item.category && item.category !== "æœªåˆ†é¡") categories.add(item.category);
        });

        const nav = document.getElementById('category-nav');
        nav.innerHTML = `<button class="cat-btn active" onclick="filterCategory('å…¨éƒ¨')">å…¨éƒ¨é …ç›®</button>`;
        categories.forEach(cat => {
            nav.innerHTML += `<button class="cat-btn" onclick="filterCategory('${cat}')">${cat}</button>`;
        });

        renderMenu(allItems);
    });

    function renderMenu(items) {
        const list = document.getElementById('menu-list');
        list.innerHTML = "";
        items.forEach(item => {
            // ç”Ÿæˆé™„åŠ é¸é …æŒ‰éˆ•
            let addonsHtml = "";
            if (item.addons && item.addons.length > 0) {
                addonsHtml = `<div class="addon-group">`;
                item.addons.forEach(addon => {
                    addonsHtml += `<div class="addon-chip" id="chip-${item.id}-${addon}" onclick="selectAddon('${item.id}', '${addon}')">${addon}</div>`;
                });
                addonsHtml += `</div>`;
            }

            list.innerHTML += `
                <div class="food-card">
                    <div class="food-img-box"><img src="${item.image || 'https://placehold.co/300'}" onerror="this.src='https://placehold.co/300?text=None'"></div>
                    <div class="food-info">
                        <span class="food-name">${item.name}</span>
                        ${item.staffNote ? `<span class="staff-note">âš ï¸ ${item.staffNote}</span>` : ''}
                        <span class="food-price">$${item.price}</span>
                        ${addonsHtml}
                        <button class="btn-add" onclick="addToCart('${item.id}', '${item.name}', ${item.price})">åŠ å…¥</button>
                    </div>
                </div>
            `;
        });
    }

    function selectAddon(itemId, addon) {
        // åŒä¸€é¤é»åªèƒ½é¸ä¸€å€‹é¸é … (å–®é¸é‚è¼¯)
        if (!currentSelections[itemId]) currentSelections[itemId] = [];
        
        // æ‰¾åˆ°è©²é¤é»çš„æ‰€æœ‰æ™¶ç‰‡ä¸¦å–æ¶ˆé¸ä¸­
        const chips = document.querySelectorAll(`[id^="chip-${itemId}-"]`);
        chips.forEach(c => c.classList.remove('selected'));
        
        // é¸ä¸­ç›®å‰çš„
        document.getElementById(`chip-${itemId}-${addon}`).classList.add('selected');
        currentSelections[itemId] = [addon];
    }

    function filterCategory(cat) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderMenu(cat === 'å…¨éƒ¨' ? allItems : allItems.filter(i => i.category === cat));
    }

    function addToCart(id, name, price) {
        const selected = currentSelections[id] || [];
        const fullName = selected.length > 0 ? `${name} (${selected.join('/')})` : name;
        cart.push({ name: fullName, price: price });
        
        // åŠ å…¥å¾Œé‡ç½®é¸æ“‡
        currentSelections[id] = [];
        const chips = document.querySelectorAll(`[id^="chip-${id}-"]`);
        chips.forEach(c => c.classList.remove('selected'));
        
        updateCartUI();
    }

    function updateCartUI() {
        const bar = document.getElementById('cart-bar');
        bar.style.display = cart.length > 0 ? 'flex' : 'none';
        document.getElementById('cart-count').innerText = cart.length;
        document.getElementById('cart-total').innerText = cart.reduce((s, i) => s + parseInt(i.price), 0);
    }

    function submitOrder() {
        const orderData = {
            table: tableNum,
            items: cart.map(i => i.name),
            total: document.getElementById('cart-total').innerText,
            status: "å¾…è™•ç†",
            time: new Date().toLocaleTimeString()
        };
        db.ref('orders/' + Date.now()).set(orderData).then(() => {
            alert("è¨‚å–®å·²é€å‡ºï¼Œè«‹è‡³æ«ƒæª¯çµå¸³ï¼");
            cart = [];
            updateCartUI();
        });
    }
</script>
</body>
</html>