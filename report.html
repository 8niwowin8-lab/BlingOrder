<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å®Œæ•´æ•¸æ“šå ±è¡¨</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg: #fcfcfc; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        
        /* çµ±è¨ˆè³‡è¨Š */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px 5px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; border: 1px solid #fff0f3; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary-pink); display: block; }
        .stat-label { font-size: 12px; color: #999; font-weight: bold; }

        /* è¡¨æ ¼å€ */
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #fdf2f4; color: #888; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; vertical-align: middle; }
        
        .tag-booth { color: var(--primary-pink); font-weight: bold; }
        .free-order { color: #4caf50; font-weight: bold; text-decoration: line-through; }
        
        /* åŠŸèƒ½æŒ‰éˆ• */
        .btn-action { border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; margin: 2px; }
        .btn-free { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .btn-del { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .btn-back { display: block; width: 100%; text-align: center; padding: 15px; background: #eee; color: #333; text-decoration: none; border-radius: 12px; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

<a href="admin.html" class="btn-back">â¬… è¿”å›æ¥å–®å¾Œå°</a>

<div class="stats-grid">
    <div class="stat-card"><span class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</span><span class="stat-val" id="today-revenue">$0</span></div>
    <div class="stat-card"><span class="stat-label">ç¸½å–®æ•¸</span><span class="stat-val" id="today-count">0</span></div>
    <div class="stat-card"><span class="stat-label">å®¢å–®åƒ¹</span><span class="stat-val" id="today-avg">$0</span></div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>æ™‚é–“/æ¡Œè™Ÿ</th>
                <th>é‡‘é¡</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="report-body"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const todayStr = new Date().toLocaleDateString('zh-TW');

    db.ref('orders').on('value', snap => {
        const tbody = document.getElementById('report-body');
        tbody.innerHTML = "";
        let todayRev = 0, todayQty = 0;
        let ordersArray = [];

        snap.forEach(child => {
            const o = child.val();
            o.id = child.key;
            ordersArray.push(o);
        });
        ordersArray.reverse();

        ordersArray.forEach(o => {
            const timeObj = new Date(parseInt(o.timestamp || o.id));
            const dateStr = timeObj.toLocaleDateString('zh-TW');
            const timeStr = timeObj.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            if (dateStr === todayStr) {
                todayRev += parseInt(o.total || 0);
                todayQty += 1;
            }

            const tableShow = (o.table == "7" || o.table == "åŒ…å»‚") ? "<span class='tag-booth'>ğŸ’åŒ…å»‚</span>" : o.table + "æ¡Œ";
            const isFree = (parseInt(o.total) === 0);

            tbody.innerHTML += `
                <tr>
                    <td><small>${timeStr}</small><br>${tableShow}</td>
                    <td class="${isFree ? 'free-order' : ''}">$${o.total}</td>
                    <td>
                        <button class="btn-action btn-free" onclick="makeFree('${o.id}')">å…å–®</button>
                        <button class="btn-action btn-del" onclick="deleteOrder('${o.id}')">åˆªé™¤</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="3" style="font-size:11px; color:#999; padding-top:0; border-bottom: 2px solid #eee;">
                        å“é …ï¼š${(o.items || []).join(', ')}
                    </td>
                </tr>`;
        });

        document.getElementById('today-revenue').innerText = `$${todayRev.toLocaleString()}`;
        document.getElementById('today-count').innerText = `${todayQty}å–®`;
        const avg = todayQty > 0 ? Math.round(todayRev / todayQty) : 0;
        document.getElementById('today-avg').innerText = `$${avg}`;
    });

    // å…å–®åŠŸèƒ½ï¼šå°‡é‡‘é¡æ”¹ç‚º 0
    function makeFree(id) {
        if(confirm("ç¢ºå®šè¦å°‡æ­¤è¨‚å–®æ”¹ç‚ºã€Œå…å–® (0å…ƒ)ã€å—ï¼Ÿ")) {
            db.ref('orders/' + id).update({ total: 0 });
        }
    }

    // åˆªé™¤åŠŸèƒ½ï¼šå¾¹åº•å¾è³‡æ–™åº«ç§»é™¤
    function deleteOrder(id) {
        if(confirm("ç¢ºå®šè¦ã€æ°¸ä¹…åˆªé™¤ã€‘é€™ç­†è¨‚å–®å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•æ¢å¾©å–”ï¼")) {
            db.ref('orders/' + id).remove();
        }
    }
</script>

</body>
</html>