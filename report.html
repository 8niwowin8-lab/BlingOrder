<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | ç‡Ÿé‹æ•¸æ“šåˆ†æä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --soft-bg: #fffafa; }
        body { font-family: "PingFang TC", sans-serif; background: var(--soft-bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .title { color: var(--primary-pink); font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        
        /* æ•¸æ“šå¡ç‰‡ */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(255,133,162,0.1); }
        .stat-val { font-size: 28px; font-weight: 800; color: var(--primary-pink); margin-top: 10px; }
        .stat-label { color: #888; font-size: 14px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #fff0f3; color: #555; padding: 15px; text-align: left; font-size: 14px; }
        td { padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 14px; color: #444; }
        tr:hover { background: #fffdfd; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-comp { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-comp:disabled { background: #f5f5f5; color: #bbb; border: 1px solid #eee; cursor: not-allowed; }
        .btn-del { background: #fff0f0; color: #ff4d4d; border: 1px solid #ffccd5; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        
        .comp-tag { background: #1976d2; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div class="title">ğŸ“Š ç‡Ÿé‹æ•¸æ“šåˆ†æä¸­å¿ƒ</div>
    <div id="today-date" style="color:#888;"></div>
</div>

<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥ç¸½è¨‚å–®</div>
        <div class="stat-val" id="total-count">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ä»Šæ—¥ç‡Ÿæ¥­é¡</div>
        <div class="stat-val" id="total-revenue">$0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ç†±é–€æ¡Œè™Ÿ</div>
        <div class="stat-val" id="top-table">--</div>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>æ™‚é–“</th>
                <th>æ¡Œè™Ÿ</th>
                <th>é¤é»æ˜ç´°</th>
                <th>é‡‘é¡</th>
                <th>ç®¡ç†æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="order-tbody">
            </tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    document.getElementById('today-date').innerText = new Date().toLocaleDateString();

    // ç›£è½è¨‚å–®æ•¸æ“š
    db.ref('orders').on('value', snap => {
        const tbody = document.getElementById('order-tbody');
        tbody.innerHTML = "";
        
        let totalRev = 0;
        let orderCount = 0;
        let tableFreq = {};

        const orders = [];
        snap.forEach(child => {
            const o = child.val();
            o.id = child.key;
            orders.unshift(o); // æœ€æ–°è¨‚å–®æ’å‰é¢
        });

        orders.forEach(o => {
            orderCount++;
            totalRev += parseInt(o.total || 0);
            tableFreq[o.table] = (tableFreq[o.table] || 0) + 1;

            const isComp = o.isComp === true;
            const rowClass = isComp ? 'style="color:#aaa;"' : '';
            const compBadge = isComp ? '<span class="comp-tag">å…å–®</span>' : '';

            tbody.innerHTML += `
                <tr ${rowClass}>
                    <td>${o.time}</td>
                    <td><b>${o.table}</b></td>
                    <td>${o.items.join('ã€')}</td>
                    <td style="font-weight:bold; color:${isComp ? '#aaa' : '#ff85a2'}">${compBadge}$${o.total}</td>
                    <td>
                        <button class="btn-comp" onclick="compOrder('${o.id}')" ${isComp ? 'disabled' : ''}>å…å–®</button>
                        <button class="btn-del" onclick="deleteOrder('${o.id}')">åˆªé™¤</button>
                    </td>
                </tr>`;
        });

        // æ›´æ–°æ•¸æ“šå¡ç‰‡
        document.getElementById('total-count').innerText = orderCount;
        document.getElementById('total-revenue').innerText = `$${totalRev}`;
        
        // è¨ˆç®—ç†±é–€æ¡Œè™Ÿ
        let max = 0, popular = "--";
        for(let t in tableFreq) {
            if(tableFreq[t] > max) { max = tableFreq[t]; popular = t + " æ¡Œ"; }
        }
        document.getElementById('top-table').innerText = popular;
    });

    // å…å–®è™•ç†é‚è¼¯
    function compOrder(id) {
        if(confirm("ç¢ºå®šè¦å°‡æ­¤è¨‚å–®è¨­ç‚ºã€Œå…å–®ã€å—ï¼Ÿ\né€™é€šå¸¸ç”¨æ–¼æ‹›å¾…æ´»å‹•ï¼ˆå¦‚ï¼šç†Ÿå¥³é€±ï¼‰ï¼Œé‡‘é¡å°‡æ­¸é›¶ã€‚")) {
            db.ref('orders/' + id).update({
                total: 0,
                isComp: true,
                note: "ç³»çµ±å…å–®/æ‹›å¾…"
            }).then(() => {
                alert("å·²æˆåŠŸè¨­å®šç‚ºå…å–®ã€‚");
            });
        }
    }

    // åˆªé™¤è¨‚å–®é‚è¼¯
    function deleteOrder(id) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®ç´€éŒ„å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•æ¢å¾©ã€‚")) {
            db.ref('orders/' + id).remove();
        }
    }
</script>
</body>
</html>