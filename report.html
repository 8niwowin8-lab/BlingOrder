<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | æ•¸æ“šå ±è¡¨ä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; }
        body { font-family: "PingFang TC", sans-serif; background: #fdfdfd; padding: 15px; margin: 0; }
        
        /* å›æ­¸åŸæœ¬çš„æ•¸æ“šé¡¯ç¤º */
        .report-header { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stats-info { display: flex; gap: 20px; margin-top: 10px; font-weight: bold; color: #555; }
        .stat-item { background: #fff0f3; padding: 5px 15px; border-radius: 20px; font-size: 14px; }

        /* å›æ­¸åŸæœ¬çš„è¡¨æ ¼ç·¨æ’ */
        .table-container { background: white; border-radius: 15px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: var(--primary-pink); color: white; padding: 15px; text-align: left; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; color: #333; }
        
        .tag-booth { color: var(--primary-pink); font-weight: bold; }
        .item-list-text { font-size: 13px; color: #666; line-height: 1.4; }
        .date-time { font-size: 12px; color: #888; }
        
        /* åŠŸèƒ½æŒ‰éˆ•ï¼šæ”¹ç´°å°ä¸€é»ï¼Œä¸å¹²æ“¾è¦–è¦º */
        .btn-act { border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 5px; background: white; font-weight: bold; }
        .btn-free { color: #2e7d32; border-color: #a5d6a7; }
        .btn-del { color: #c62828; border-color: #ef9a9a; }
        
        .btn-back { display: inline-block; text-decoration: none; color: #888; margin-bottom: 15px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div class="report-header">
    <a href="admin.html" class="btn-back">â¬… è¿”å›æ¥å–®å¾Œå°</a>
    <h1 style="margin:0; font-size:24px; color:#333;">ğŸ“Š ç‡Ÿæ”¶å ±è¡¨æ˜ç´°</h1>
    <div class="stats-info">
        <div class="stat-item">ä»Šæ—¥ç‡Ÿæ”¶ï¼š<span id="rev-val">$0</span></div>
        <div class="stat-item">å–®æ•¸ï¼š<span id="qty-val">0</span></div>
        <div class="stat-item">å¹³å‡ï¼š<span id="avg-val">$0</span></div>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>æ—¥æœŸæ™‚é–“</th>
                <th>æ¡Œè™Ÿ</th>
                <th>é‡‘é¡</th>
                <th>å“é …æ¸…å–®</th>
                <th>ç®¡ç†</th>
            </tr>
        </thead>
        <tbody id="report-body">
            </tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const todayStr = new Date().toLocaleDateString('zh-TW');

    db.ref('orders').on('value', snap => {
        const tbody = document.getElementById('report-body');
        tbody.innerHTML = "";
        let rev = 0, qty = 0;
        let list = [];

        snap.forEach(child => {
            const o = child.val();
            o.id = child.key;
            list.push(o);
        });
        list.reverse();

        list.forEach(o => {
            const timeObj = new Date(parseInt(o.timestamp || o.id));
            const dStr = timeObj.toLocaleDateString('zh-TW');
            const tStr = timeObj.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});

            if (dStr === todayStr) {
                rev += parseInt(o.total || 0);
                qty += 1;
            }

            const isB = (o.table == "7" || o.table == "åŒ…å»‚");
            const priceVal = parseInt(o.total);

            tbody.innerHTML += `
                <tr>
                    <td class="date-time"><b>${dStr}</b><br>${tStr}</td>
                    <td>${isB ? '<span class="tag-booth">ğŸ’åŒ…å»‚</span>' : o.table + ' æ¡Œ'}</td>
                    <td style="font-weight:bold; ${priceVal === 0 ? 'color:#4caf50;text-decoration:line-through;' : ''}">$${o.total}</td>
                    <td class="item-list-text">${(o.items || []).join('ã€')}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn-act btn-free" onclick="doFree('${o.id}')">å…å–®</button>
                        <button class="btn-act btn-del" onclick="doDel('${o.id}')">åˆªé™¤</button>
                    </td>
                </tr>`;
        });

        document.getElementById('rev-val').innerText = `$${rev.toLocaleString()}`;
        document.getElementById('qty-val').innerText = qty;
        document.getElementById('avg-val').innerText = `$${qty > 0 ? Math.round(rev/qty) : 0}`;
    });

    function doFree(id) {
        if(confirm("ç¢ºå®šè¦å°‡é€™ç­†æ”¹ç‚º 0 å…ƒå—ï¼Ÿ")) {
            db.ref('orders/' + id).update({ total: 0 });
        }
    }

    function doDel(id) {
        if(confirm("æ°¸ä¹…åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œç¢ºå®šå—ï¼Ÿ")) {
            db.ref('orders/' + id).remove();
        }
    }
</script>
</body>
</html>