<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å°ˆæ¥­èœå–®ç®¡ç†</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg-color: #fff5f7; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg-color); padding: 20px; color: #333; }
        .edit-panel { background: white; padding: 25px; border-radius: 15px; border: 2px solid var(--primary-pink); max-width: 800px; margin: 0 auto 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-row { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* åœ–ç‰‡ä¸Šå‚³å€åŸŸ */
        .upload-area { border: 2px dashed #ffb6c1; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; background: #fafafa; transition: 0.3s; position: relative; }
        .upload-area:hover { border-color: var(--primary-pink); background: #fff0f3; }
        #preview-img { max-width: 150px; border-radius: 10px; display: none; margin: 10px auto; border: 1px solid #eee; }
        .upload-hint { color: #888; font-size: 14px; }

        /* é™„åŠ é¸é …æ¨£å¼ */
        .option-group { display: flex; gap: 15px; flex-wrap: wrap; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .option-item { display: flex; align-items: center; gap: 8px; font-size: 15px; cursor: pointer; padding: 5px 10px; background: white; border-radius: 5px; border: 1px solid #eee; }
        .option-item input { width: 18px; height: 18px; cursor: pointer; }

        .btn-save { width: 100%; padding: 18px; background: var(--primary-pink); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 20px; cursor: pointer; margin-top: 20px; }
        .btn-cancel { background: none; border: none; color: #999; width: 100%; padding: 10px; cursor: pointer; text-decoration: underline; }

        table { width: 100%; background: white; border-collapse: collapse; border-radius: 15px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; }
        th { background: #fff0f3; }
        .list-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }
        .btn-action { padding: 6px 12px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-edit { background: #4a90e2; color: white; margin-right: 5px; }
        .btn-del { background: #eee; color: #888; }
    </style>
</head>
<body>

<div class="edit-panel">
    <h3 id="form-title">âœ¨ èœå–®é€²éšç®¡ç†</h3>
    <input type="hidden" id="edit-id" value="">
    
    <div class="input-row">
        <label>é¤é»åˆ†é¡ (ä¾‹å¦‚ï¼šå’–å•¡é¡ã€ç”œé»é¡)</label>
        <input type="text" id="category" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±">
    </div>

    <div class="input-row">
        <label>é¤é»åç¨±</label>
        <input type="text" id="name" placeholder="è«‹è¼¸å…¥é¤é»åç¨±">
    </div>

    <div class="input-row">
        <label>åƒ¹æ ¼</label>
        <input type="number" id="price" placeholder="è«‹è¼¸å…¥åƒ¹æ ¼">
    </div>

    <div class="input-row">
        <label>é¤é»ç…§ç‰‡ (é»æ“Šä¸‹æ–¹å€åŸŸä¸Šå‚³)</label>
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <span id="upload-status" class="upload-hint">ğŸ“¸ é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹ç…§</span>
            <img id="preview-img">
            <input type="file" id="file-input" accept="image/*" style="display:none" onchange="uploadToImgur(this)">
            <input type="hidden" id="image-url">
        </div>
    </div>

    <div class="input-row">
        <label>å·¥ä½œäººå“¡è­¦èªå‚™è¨»</label>
        <input type="text" id="staff-note" placeholder="ä¾‹ï¼šæœ¬é£²å“å«æç¥é£²æ–™ï¼Œä¸å»ºè­°å­•å©¦åŠå…’ç«¥">
    </div>

    <div class="input-row">
        <label>é™„åŠ é¸é … (å¤šé¸)</label>
        <div class="option-group" id="addon-options">
            <label class="option-item"><input type="checkbox" value="å†°"> å†°</label>
            <label class="option-item"><input type="checkbox" value="å»å†°"> å»å†°</label>
            <label class="option-item"><input type="checkbox" value="ç†±"> ç†±</label>
            <label class="option-item"><input type="checkbox" value="ç„¡ç³–"> ç„¡ç³–</label>
            <label class="option-item"><input type="checkbox" value="åŠ ç³–"> åŠ ç³–</label>
        </div>
    </div>

    <button class="btn-save" id="submit-btn" onclick="saveToFirebase()">å„²å­˜ä¸¦ç™¼å¸ƒ âœ¨</button>
    <button class="btn-cancel" onclick="resetForm()">å–æ¶ˆç·¨è¼¯ / æ¸…ç©ºæ¬„ä½</button>
</div>

<table>
    <thead>
        <tr><th>åˆ†é¡</th><th>åœ–ç‰‡</th><th>åç¨±/åƒ¹æ ¼</th><th>è­¦èª/é¸é …</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody id="menu-tbody"></tbody>
</table>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. ä¿®å¾©åœ–ç‰‡ä¸Šå‚³
    async function uploadToImgur(input) {
        const file = input.files[0];
        if (!file) return;

        const status = document.getElementById('upload-status');
        const submitBtn = document.getElementById('submit-btn');
        status.innerText = "â³ ä¸Šå‚³ä¸­...";
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('image', file);

        try {
            const res = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: { Authorization: 'Client-ID 73499b951474d2b' }, // ä½¿ç”¨é€šç”¨ ID
                body: formData
            });
            const result = await res.json();
            if (result.success) {
                const url = result.data.link;
                document.getElementById('image-url').value = url;
                const preview = document.getElementById('preview-img');
                preview.src = url;
                preview.style.display = 'block';
                status.style.display = 'none';
                alert("åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼");
            } else {
                throw new Error(result.data.error);
            }
        } catch (e) {
            alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯ã€‚");
            status.innerText = "ğŸ“¸ é»æ“Šé‡è©¦";
        } finally {
            submitBtn.disabled = false;
        }
    }

    // 2. ä¿®å¾©å„²å­˜èˆ‡ä¿®æ”¹é‚è¼¯
    function saveToFirebase() {
        const editId = document.getElementById('edit-id').value;
        const id = editId || Date.now(); // å¦‚æœæœ‰ ID å‰‡æ˜¯ä¿®æ”¹ï¼Œå¦å‰‡æ–°å¢
        
        const addons = [];
        document.querySelectorAll('#addon-options input:checked').forEach(cb => addons.push(cb.value));

        const data = {
            category: document.getElementById('category').value || "æœªåˆ†é¡",
            name: document.getElementById('name').value,
            price: document.getElementById('price').value,
            image: document.getElementById('image-url').value || "",
            staffNote: document.getElementById('staff-note').value || "",
            addons: addons,
            isSoldOut: false
        };

        if(!data.name || !data.price) return alert("åç¨±èˆ‡åƒ¹æ ¼ç‚ºå¿…å¡«ï¼");

        db.ref('menu/' + id).set(data).then(() => {
            alert("å„²å­˜æˆåŠŸï¼");
            resetForm();
        }).catch(err => alert("å„²å­˜å¤±æ•—ï¼š" + err.message));
    }

    // 3. ä¿®å¾©ã€Œä¿®æ”¹ã€æŒ‰éˆ•ï¼šå°‡è³‡æ–™å¸¶å›ä¸Šæ–¹è¡¨å–®
    function startEdit(id) {
        db.ref('menu/' + id).once('value', snap => {
            const item = snap.val();
            document.getElementById('edit-id').value = id;
            document.getElementById('form-title').innerText = "âœï¸ æ­£åœ¨ä¿®æ”¹ï¼š" + item.name;
            document.getElementById('category').value = item.category;
            document.getElementById('name').value = item.name;
            document.getElementById('price').value = item.price;
            document.getElementById('staff-note').value = item.staffNote || "";
            document.getElementById('image-url').value = item.image || "";
            
            // è™•ç†åœ–ç‰‡é è¦½
            const preview = document.getElementById('preview-img');
            const status = document.getElementById('upload-status');
            if(item.image) {
                preview.src = item.image;
                preview.style.display = 'block';
                status.style.display = 'none';
            } else {
                preview.style.display = 'none';
                status.style.display = 'block';
            }

            // è™•ç†å‹¾é¸æ¡†
            const addons = item.addons || [];
            document.querySelectorAll('#addon-options input').forEach(cb => {
                cb.checked = addons.includes(cb.value);
            });

            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function resetForm() {
        document.getElementById('edit-id').value = "";
        document.getElementById('form-title').innerText = "âœ¨ èœå–®é€²éšç®¡ç†";
        document.querySelectorAll('input[type="text"], input[type="number"], #image-url').forEach(i => i.value = "");
        document.querySelectorAll('#addon-options input').forEach(cb => cb.checked = false);
        document.getElementById('preview-img').style.display = 'none';
        document.getElementById('upload-status').style.display = 'block';
        document.getElementById('upload-status').innerText = "ğŸ“¸ é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹ç…§";
    }

    // å¯¦æ™‚è®€å–æ¸…å–®
    db.ref('menu').on('value', snap => {
        const tbody = document.getElementById('menu-tbody');
        tbody.innerHTML = "";
        snap.forEach(child => {
            const i = child.val();
            tbody.innerHTML += `
                <tr>
                    <td>${i.category}</td>
                    <td><img src="${i.image}" class="list-img" onerror="this.src='https://placehold.co/100?text=None'"></td>
                    <td><b>${i.name}</b><br>$${i.price}</td>
                    <td>
                        <span style="color:red; font-size:12px;">${i.staffNote || ''}</span>
                        <div style="font-size:11px; color:#888;">${(i.addons || []).join('/')}</div>
                    </td>
                    <td>
                        <button class="btn-action btn-edit" onclick="startEdit('${child.key}')">ä¿®æ”¹</button>
                        <button class="btn-action btn-del" onclick="if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref('menu/${child.key}').remove()">åˆªé™¤</button>
                    </td>
                </tr>`;
        });
    });
</script>
</body>
</html>