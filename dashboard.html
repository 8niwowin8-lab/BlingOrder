<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | æ ¸å¿ƒæ•¸æ“šä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #fffafb; margin: 0; padding: 20px; }
        .header { text-align: center; color: #ff85a2; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 15px; border: 1px solid #ffafcc; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stat-card h3 { margin: 0; color: #888; font-size: 14px; }
        .stat-card .val { font-size: 28px; font-weight: bold; color: #d63384; margin-top: 10px; }
        
        .chart-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 20px; border: 1px solid #ffafcc; min-height: 400px; }
        h2 { color: #ff85a2; font-size: 1.2em; margin-bottom: 20px; border-left: 5px solid #ffafcc; padding-left: 10px; }
    </style>
</head>
<body>

    <div class="header"><h1>ğŸ’ BlingOrder ç‡Ÿé‹æ•¸æ“šåˆ†æ</h1></div>

    <div class="stats-grid">
        <div class="stat-card"><h3>ğŸ“… æœ¬æ—¥ç‡Ÿæ”¶</h3><div class="val">$<span id="day-rev">0</span></div></div>
        <div class="stat-card"><h3>ğŸ“… æœ¬å‘¨ç‡Ÿæ”¶</h3><div class="val">$<span id="week-rev">0</span></div></div>
        <div class="stat-card"><h3>ğŸ“… æœ¬æœˆç‡Ÿæ”¶</h3><div class="val">$<span id="month-rev">0</span></div></div>
        <div class="stat-card"><h3>ğŸ“ˆ ç´¯è¨ˆç¸½ç‡Ÿæ”¶</h3><div class="val">$<span id="total-rev">0</span></div></div>
    </div>

    <div class="chart-container">
        <div class="chart-card">
            <h2>ğŸ¥§ ç†±éŠ·å“é …ä½”æ¯”</h2>
            <canvas id="pieChart"></canvas>
        </div>
        <div class="chart-card">
            <h2>ğŸ† éŠ·å”®æ’è¡Œæ¦œ</h2>
            <div id="rank-list"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPieChart = null;

    db.ref('orders').on('value', snap => {
        let dayRev = 0, weekRev = 0, monthRev = 0, totalRev = 0;
        let itemCounts = {};
        
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        
        snap.forEach(child => {
            const o = child.val();
            if (o.status === 'å·²å®Œæˆ') {
                const amount = parseInt(o.total);
                totalRev += amount;
                
                // æ—¥æœŸåˆ¤æ–· (å‡è¨­ o.date å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡ç”¨æ™‚é–“æˆ³æ¨ç®—)
                const orderDate = o.date ? new Date(o.date) : new Date();
                const diffTime = Math.abs(now - orderDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (o.date === todayStr) dayRev += amount;
                if (diffDays <= 7) weekRev += amount;
                if (diffDays <= 30) monthRev += amount;

                // çµ±è¨ˆå“é …
                o.items.forEach(name => {
                    itemCounts[name] = (itemCounts[name] || 0) + 1;
                });
            }
        });

        // æ›´æ–°æ•¸å­—
        document.getElementById('day-rev').innerText = dayRev;
        document.getElementById('week-rev').innerText = weekRev;
        document.getElementById('month-rev').innerText = monthRev;
        document.getElementById('total-rev').innerText = totalRev;

        updateCharts(itemCounts);
    });

    function updateCharts(itemCounts) {
        const labels = Object.keys(itemCounts);
        const data = Object.values(itemCounts);

        // æ›´æ–°åœ“é¤…åœ–
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (myPieChart) myPieChart.destroy();
        myPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#ffadcc', '#ffccbb', '#ffee99', '#99ffcc', '#99ccff', '#cc99ff']
                }]
            }
        });

        // æ›´æ–°æ’è¡Œæ–‡å­—
        const rankDiv = document.getElementById('rank-list');
        const sorted = Object.entries(itemCounts).sort((a,b) => b[1] - a[1]);
        rankDiv.innerHTML = sorted.map((it, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span>${i+1}. ${it[0]}</span>
                <b>${it[1]} ä»½</b>
            </div>
        `).join('');
    }
</script>
</body>
</html>
