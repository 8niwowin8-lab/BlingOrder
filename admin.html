<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | çµ‚æ¥µç›£æ§å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --soft-pink: #fffafa; }
        body { font-family: "PingFang TC", sans-serif; background: #fdfdfd; margin: 0; padding: 15px; }
        .admin-header { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 2px solid var(--primary-pink); }
        .revenue-box { background: var(--primary-pink); color: white; padding: 10px 20px; border-radius: 12px; text-align: right; }
        
        .order-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-left: 12px solid #333; }
        .table-tag { font-size: 32px; font-weight: 900; color: #333; margin-bottom: 15px; display: block; background: #eee; padding: 5px 15px; border-radius: 10px; width: fit-content; }
        .item-list { border-top: 2px solid #eee; padding-top: 15px; }
        .item-row { padding: 12px 0; border-bottom: 1px solid #f0f0f0; color: #000; font-size: 24px; font-weight: bold; }
        .total-info { margin-top: 20px; font-size: 22px; font-weight: 800; color: #e91e63; text-align: right; }
        
        .btn-done { background: #4caf50; color: white; border: none; padding: 20px; border-radius: 15px; font-weight: bold; margin-top: 20px; width: 100%; font-size: 20px; cursor: pointer; }
        .voice-btn { width: 100%; padding: 15px; background: #2196f3; color: white; border: none; border-radius: 15px; font-weight: bold; margin-bottom: 20px; font-size: 18px; }
    </style>
</head>
<body>

<div class="admin-header">
    <div>
        <h1 style="font-size:24px; color:var(--primary-pink); margin:0;">ğŸ’ å³æ™‚è¨‚å–® (æ‰€æœ‰)</h1>
        <p style="margin:5px 0; font-size:14px; color:#888;">è«‹é–‹å•ŸèªéŸ³ä¸¦ä¿æŒç•«é¢é–‹å•Ÿ</p>
    </div>
    <div class="revenue-box">
        <div style="font-size:12px;">ä»Šæ—¥ç´¯è¨ˆ</div>
        <div id="rev-val" style="font-size:26px; font-weight:800;">$0</div>
    </div>
</div>

<button class="voice-btn" onclick="startVoice()" id="v-btn">ğŸ”Š é»æˆ‘ï¼šé–‹å•ŸèªéŸ³æé†’</button>

<div id="list-box">
    <p style="text-align:center; padding:50px; color:#999; font-size:20px;">æ­£åœ¨è®€å–è¨‚å–®ä¸­...</p>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let canSpeak = false;
    let knownOrderIds = new Set();

    function startVoice() {
        canSpeak = true;
        document.getElementById('v-btn').innerText = "âœ… èªéŸ³å·²å°±ç·’";
        document.getElementById('v-btn').style.background = "#8bc34a";
        const msg = new SpeechSynthesisUtterance("èªéŸ³ç³»çµ±é–‹å•Ÿ");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    const todayStr = new Date().toLocaleDateString('zh-TW');

    db.ref('orders').on('value', snap => {
        const listBox = document.getElementById('list-box');
        listBox.innerHTML = "";
        
        let todaySum = 0;
        let foundNew = false;

        snap.forEach(child => {
            const o = child.val();
            const id = child.key;
            
            // è¨ˆç®—ä»Šæ—¥ç‡Ÿæ”¶ (æ¯”å°æ—¥æœŸ)
            const orderDate = new Date(parseInt(o.timestamp || id)).toLocaleDateString('zh-TW');
            if (orderDate === todayStr) {
                todaySum += parseInt(o.total || 0);
            }

            // åªè¦ status ä¸æ˜¯ "å·²çµå¸³"ï¼Œé€šé€šé¡¯ç¤ºå‡ºä¾† (ç¢ºä¿ä¸€å®šçœ‹å¾—åˆ°)
            if (o.status !== "å·²çµå¸³") {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°è¨‚å–®(èªéŸ³ç”¨)
                if (!knownOrderIds.has(id) && knownOrderIds.size > 0) {
                    foundNew = true;
                }
                knownOrderIds.add(id);

                const tableShow = (o.table == "7" || o.table == "åŒ…å»‚") ? "âœ¨ åŒ…å»‚" : "ç¬¬ " + o.table + " æ¡Œ";
                let itemsHtml = (o.items || []).map(i => `<div class="item-row">â— ${i}</div>`).join('');
                
                const card = `
                    <div class="order-card">
                        <span class="table-tag">${tableShow}</span>
                        <div class="item-list">${itemsHtml}</div>
                        <div class="total-info">é‡‘é¡ï¼š$${o.total}</div>
                        <button class="btn-done" onclick="finishOrder('${id}')">âœ“ å®Œæˆä¸‹å–®/çµå¸³</button>
                    </div>`;
                listBox.innerHTML = card + listBox.innerHTML; 
            }
        });

        if (foundNew && canSpeak) {
            const msg = new SpeechSynthesisUtterance("æ‚¨æœ‰æ–°è¨‚å–®");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        document.getElementById('rev-val').innerText = "$" + todaySum.toLocaleString();
        if (listBox.innerHTML === "") {
            listBox.innerHTML = `<p style="text-align:center; padding:50px; color:#ccc; font-size:20px;">ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</p>`;
        }
    });

    function finishOrder(id) {
        if(confirm("ç¢ºå®šå®Œæˆé€™ç­†è¨‚å–®ï¼Ÿå®Œæˆå¾Œæœƒå¾ç•«é¢ä¸Šæ¶ˆå¤±ä¸¦è¨ˆå…¥å ±è¡¨ã€‚")) {
            db.ref('orders/' + id).update({ status: "å·²çµå¸³" });
        }
    }
</script>
</body>
</html>