<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | èªéŸ³åŠ å¼·ç‰ˆå¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg: #fdfdfd; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* å•Ÿå‹•é–€ç°¾ */
        #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-pink); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .start-btn { padding: 30px 60px; font-size: 40px; font-weight: 900; background: white; color: var(--primary-pink); border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }

        .admin-header { background: white; padding: 20px; border-bottom: 3px solid var(--primary-pink); display: flex; justify-content: space-between; align-items: center; }
        .rev-info { text-align: right; background: #333; color: white; padding: 10px 20px; border-radius: 12px; }

        .order-list-container { padding: 15px; }
        .order-row { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 2px solid #eee; display: flex; align-items: center; }
        
        .table-box { min-width: 140px; text-align: center; border-right: 3px solid #eee; margin-right: 25px; }
        .table-text { font-size: 36px; font-weight: 900; color: #333; }
        .table-text.booth { color: var(--primary-pink); }
        
        .items-box { flex-grow: 1; }
        .item-detail { font-size: 32px; font-weight: 800; color: #000; line-height: 1.4; }
        
        .action-box { min-width: 200px; text-align: right; margin-left: 20px; }
        .price-text { font-size: 24px; font-weight: bold; color: var(--primary-pink); margin-bottom: 15px; }
        .btn-done { background: #4caf50; color: white; border: none; padding: 20px 30px; border-radius: 15px; font-size: 24px; font-weight: bold; cursor: pointer; width: 100%; }

        .report-link { display: block; text-align: center; padding: 15px; color: #888; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="voice-overlay">
    <h1 style="font-size: 32px; margin-bottom: 30px;">ğŸ“¢ æº–å‚™æ¥å–®å›‰ï¼</h1>
    <button class="start-btn" onclick="initVoice()">é»æ­¤å•Ÿå‹•èªéŸ³</button>
</div>

<div class="admin-header">
    <h1 style="margin:0; font-size:24px; color:var(--primary-pink);">ğŸ’ æ¥å–®ç›£æ§</h1>
    <div class="rev-info">
        <div id="rev-val" style="font-size:24px; font-weight:bold;">$0</div>
    </div>
</div>

<div class="order-list-container" id="list-box"></div>

<a href="report.html" class="report-link">æŸ¥çœ‹ä»Šæ—¥å ±è¡¨ â®•</a>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let isSystemReady = false;
    let knownOrderIds = null; // åˆå§‹è¨­ç‚º nullï¼Œæ–¹ä¾¿ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚æ¨™è¨˜
    const todayStr = new Date().toLocaleDateString('zh-TW');

    function initVoice() {
        isSystemReady = true;
        document.getElementById('voice-overlay').style.display = 'none';
        
        // è§£æ±ºéƒ¨åˆ†ç€è¦½å™¨éœéŸ³å•é¡Œ
        const msg = new SpeechSynthesisUtterance("èªéŸ³æé†’å·²å°±ç·’");
        msg.lang = 'zh-TW';
        msg.volume = 1.0;
        window.speechSynthesis.speak(msg);
    }

    db.ref('orders').on('value', snap => {
        const listBox = document.getElementById('list-box');
        listBox.innerHTML = "";
        let todaySum = 0;
        let shouldSpeak = false;
        let currentIds = new Set();

        snap.forEach(child => {
            const o = child.val();
            const id = child.key;
            const orderDate = new Date(parseInt(o.timestamp || id)).toLocaleDateString('zh-TW');

            if (orderDate === todayStr) {
                todaySum += parseInt(o.total || 0);

                if (o.status !== "å·²çµå¸³") {
                    currentIds.add(id);
                    
                    // ã€é—œéµé‚è¼¯ã€‘ï¼šå¦‚æœé€™å¼µå–® ID æ²’çœ‹éï¼Œä¸”ä¸æ˜¯ç¬¬ä¸€æ¬¡å‰›é–‹ç¶²é ï¼Œå°±æ’­å ±
                    if (knownOrderIds !== null && !knownOrderIds.has(id)) {
                        shouldSpeak = true;
                    }

                    const isB = (o.table == "7" || o.table == "åŒ…å»‚");
                    listBox.innerHTML = `
                        <div class="order-row">
                            <div class="table-box"><div class="table-text ${isB ? 'booth' : ''}">${isB ? 'ğŸ’åŒ…å»‚' : o.table + 'æ¡Œ'}</div></div>
                            <div class="items-box"><div class="item-detail">${(o.items || []).join('ã€')}</div></div>
                            <div class="action-box">
                                <div class="price-text">$${o.total}</div>
                                <button class="btn-done" onclick="finishOrder('${id}')">çµå¸³</button>
                            </div>
                        </div>` + listBox.innerHTML;
                }
            }
        });

        // ç¬¬ä¸€æ¬¡è¼‰å…¥å¾Œï¼Œæ›´æ–°å·²çŸ¥çš„ ID æ¸…å–®
        if (knownOrderIds === null) {
            knownOrderIds = currentIds;
        } else {
            if (shouldSpeak && isSystemReady) {
                const msg = new SpeechSynthesisUtterance("æ‚¨æœ‰æ–°è¨‚å–®");
                msg.lang = 'zh-TW';
                msg.volume = 1.0;
                window.speechSynthesis.cancel(); // å…ˆå–æ¶ˆæ­£åœ¨èªªçš„è©±ï¼Œé¿å…å»¶é²
                window.speechSynthesis.speak(msg);
            }
            knownOrderIds = currentIds;
        }

        document.getElementById('rev-val').innerText = "$" + todaySum.toLocaleString();
    });

    function finishOrder(id) {
        db.ref('orders/' + id).update({ status: "å·²çµå¸³" });
    }
</script>
</body>
</html>