<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å¾Œå°ç·Šæ€¥ä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --soft-pink: #fffafa; }
        body { font-family: "PingFang TC", sans-serif; background: var(--soft-pink); margin: 0; padding: 20px; }
        .admin-header { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #fff0f3; }
        .revenue-box { background: var(--primary-pink); color: white; padding: 10px 20px; border-radius: 12px; text-align: right; }
        .order-container { display: flex; flex-direction: column; gap: 15px; }
        .order-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); border-left: 10px solid var(--primary-pink); }
        .table-tag { font-size: 22px; font-weight: bold; color: #333; margin-bottom: 10px; display: block; }
        .item-row { padding: 8px 0; border-bottom: 1px solid #f9f9f9; color: #444; font-size: 18px; }
        .btn-done { background: #ff85a2; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; margin-top: 15px; width: 100%; font-size: 16px; }
        .debug-info { background: #eee; padding: 10px; font-size: 12px; margin-top: 50px; border-radius: 5px; color: #666; }
    </style>
</head>
<body>

<div class="admin-header">
    <div>
        <h1 style="font-size:24px; color:var(--primary-pink); margin:0;">ğŸ’ è¨‚å–®å³æ™‚ç›£æ§</h1>
        <p id="date-label" style="margin:5px 0; font-size:14px; color:#888;"></p>
    </div>
    <div class="revenue-box">
        <div style="font-size:12px;">ä»Šæ—¥ç‡Ÿæ¥­é¡</div>
        <div id="rev-val" style="font-size:26px; font-weight:800;">$0</div>
    </div>
</div>

<button id="voice-init" onclick="startVoice()" style="width:100%; padding:15px; background:#4a90e2; color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:20px; font-size:16px;">é»æˆ‘ï¼šå•Ÿå‹•ã€Œæ–°è¨‚å–®èªéŸ³æé†’ã€</button>

<div class="order-container" id="list-box">
    <p style="text-align:center; color:#999;">æ­£åœ¨é€£ç·šè‡³è³‡æ–™åº«...</p>
</div>

<div class="debug-info" id="debug-log">ç³»çµ±ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­...</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let canSpeak = false;
    let oldOrderCount = -1;

    function startVoice() {
        canSpeak = true;
        document.getElementById('voice-init').innerText = "ğŸ”Š èªéŸ³æé†’é‹ä½œä¸­";
        document.getElementById('voice-init').style.background = "#2ecc71";
        const msg = new SpeechSynthesisUtterance("èªéŸ³ç³»çµ±å·²å•Ÿå‹•");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    const todayStr = new Date().toLocaleDateString('zh-TW');
    document.getElementById('date-label').innerText = "ä»Šæ—¥æ—¥æœŸï¼š" + todayStr;

    // ç›£è½æ‰€æœ‰è¨‚å–®
    db.ref('orders').on('value', snap => {
        const listBox = document.getElementById('list-box');
        const debugLog = document.getElementById('debug-log');
        listBox.innerHTML = "";
        
        let todaySum = 0;
        let count = 0;
        let orderList = [];

        snap.forEach(child => {
            const o = child.val();
            const id = child.key;
            // è½‰è­¯æ¡Œè™Ÿï¼š7 è™Ÿè½‰åŒ…å»‚
            const tableShow = (o.table == "7" || o.table == "åŒ…å»‚") ? "âœ¨ åŒ…å»‚" : "ç¬¬ " + o.table + " æ¡Œ";
            const orderDate = new Date(parseInt(o.timestamp || id)).toLocaleDateString('zh-TW');

            if (orderDate === todayStr) {
                todaySum += parseInt(o.total || 0);
                // åªè¦æ˜¯ä»Šå¤©çš„ï¼Œé€šé€šæŠ“é€²ä¾†é¡¯ç¤º (ä¸åˆ†ç‹€æ…‹ï¼Œå…ˆæ±‚çœ‹å¾—åˆ°)
                orderList.unshift({ id, ...o, tableShow }); 
            }
            count++;
        });

        // èªéŸ³æ’­å ±
        if (oldOrderCount !== -1 && orderList.length > oldOrderCount) {
            if (canSpeak) {
                const msg = new SpeechSynthesisUtterance("æ‚¨æœ‰æ–°è¨‚å–®ï¼Œè«‹ç¢ºèª");
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);
            }
        }
        oldOrderCount = orderList.length;

        // é¡¯ç¤ºè¨‚å–®
        if (orderList.length === 0) {
            listBox.innerHTML = `<p style="text-align:center; color:#ccc; margin-top:50px;">ä»Šæ—¥å°šç„¡è¨‚å–®</p>`;
        } else {
            orderList.forEach(o => {
                let itemsHtml = (o.items || []).map(i => `<div class="item-row">â— ${i}</div>`).join('');
                listBox.innerHTML += `
                    <div class="order-card">
                        <span class="table-tag">${o.tableShow}</span>
                        <div>${itemsHtml}</div>
                        <div style="margin-top:15px; font-weight:bold; color:var(--primary-pink); font-size:20px;">ç¸½é¡ï¼š$${o.total}</div>
                        <button class="btn-done" onclick="deleteOrder('${o.id}')">å®Œæˆä¸¦å¾ç•«é¢ä¸Šç§»é™¤</button>
                    </div>`;
            });
        }

        document.getElementById('rev-val').innerText = "$" + todaySum.toLocaleString();
        debugLog.innerText = `ç³»çµ±ç‹€æ…‹ï¼šå·²è®€å– ${count} ç­†æ­·å²è³‡æ–™ï¼Œä»Šæ—¥æœ‰ ${orderList.length} ç­†è¨‚å–®ã€‚`;
    });

    function deleteOrder(id) {
        if(confirm("ç¢ºå®šè¦ç§»é™¤é€™ç­†è¨‚å–®å—ï¼Ÿ")) {
            // é€™è£¡ç‚ºäº†è®“ Eden ç¾å ´å¥½æ“ä½œï¼Œæˆ‘å€‘å…ˆç”¨ update ç‹€æ…‹çš„æ–¹å¼ï¼Œé¿å…èª¤åˆªè³‡æ–™
            db.ref('orders/' + id).update({ timestamp: 0 }); // æŠŠæ™‚é–“æˆ³æ­¸é›¶ï¼Œå®ƒå°±ä¸æœƒå‡ºç¾åœ¨ã€Œä»Šå¤©ã€
        }
    }
</script>
</body>
</html>