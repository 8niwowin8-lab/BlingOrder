<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | é›™æ§ç®¡ç†å¾Œå°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --bg: #fdfdfd; }
        body { font-family: "PingFang TC", sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* å•Ÿå‹•é–€ç°¾ */
        #voice-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-pink); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .start-btn { padding: 30px 60px; font-size: 40px; font-weight: 900; background: white; color: var(--primary-pink); border: none; border-radius: 50px; cursor: pointer; }

        .admin-header { background: white; padding: 20px; border-bottom: 3px solid var(--primary-pink); display: flex; justify-content: space-between; align-items: center; }
        .rev-info { text-align: right; background: #333; color: white; padding: 10px 20px; border-radius: 12px; }

        .order-list-container { padding: 15px; }
        .order-row { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 2px solid #eee; display: flex; align-items: center; }
        
        .table-box { min-width: 140px; text-align: center; border-right: 3px solid #eee; margin-right: 25px; }
        .table-text { font-size: 36px; font-weight: 900; color: #333; }
        .table-text.booth { color: var(--primary-pink); }
        
        .items-box { flex-grow: 1; }
        .item-detail { font-size: 32px; font-weight: 800; color: #000; line-height: 1.4; }
        
        .action-box { min-width: 250px; text-align: right; margin-left: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-base { border: none; padding: 15px; border-radius: 12px; font-size: 22px; font-weight: 900; cursor: pointer; transition: 0.2s; }
        
        .btn-pay { background: #ffc107; color: #333; box-shadow: 0 4px 0 #d39e00; }
        .btn-pay.done { background: #e0e0e0; color: #999; box-shadow: none; cursor: default; transform: none; }
        
        .btn-ship { background: #4caf50; color: white; box-shadow: 0 4px 0 #2e7d32; }
        .btn-ship:active { transform: translateY(4px); box-shadow: 0 1px 0 #2e7d32; }

        .price-text { font-size: 24px; font-weight: bold; color: var(--primary-pink); margin-bottom: 5px; }
        .report-link { display: block; text-align: center; padding: 20px; color: #888; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="voice-overlay">
    <button class="start-btn" onclick="initVoice()">å•Ÿå‹•ç³»çµ±</button>
</div>

<div class="admin-header">
    <h1 style="margin:0; font-size:24px; color:var(--primary-pink);">ğŸ’ BlingOrder æ¥å–®çœ‹æ¿</h1>
    <div class="rev-info"><div id="rev-val" style="font-size:24px; font-weight:bold;">$0</div></div>
</div>

<div class="order-list-container" id="list-box"></div>

<a href="report.html" class="report-link">æŸ¥çœ‹ä»Šæ—¥å ±è¡¨ â®•</a>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let isSystemReady = false;
    let knownOrderIds = null;
    const todayStr = new Date().toLocaleDateString('zh-TW');

    function initVoice() {
        isSystemReady = true;
        document.getElementById('voice-overlay').style.display = 'none';
        window.speechSynthesis.speak(new SpeechSynthesisUtterance("ç³»çµ±å°±ç·’"));
    }

    db.ref('orders').on('value', snap => {
        const listBox = document.getElementById('list-box');
        listBox.innerHTML = "";
        let todaySum = 0;
        let shouldSpeak = false;
        let currentIds = new Set();

        snap.forEach(child => {
            const o = child.val();
            const id = child.key;
            const orderDate = new Date(parseInt(o.timestamp || id)).toLocaleDateString('zh-TW');

            if (orderDate === todayStr) {
                todaySum += parseInt(o.total || 0);

                // å¦‚æœé‚„æ²’å‡ºé¤ï¼Œå°±é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
                if (o.status !== "å·²å‡ºé¤") {
                    currentIds.add(id);
                    if (knownOrderIds !== null && !knownOrderIds.has(id)) shouldSpeak = true;

                    const isB = (o.table == "7" || o.table == "åŒ…å»‚");
                    const isPaid = (o.payStatus === "å·²çµå¸³");

                    listBox.innerHTML = `
                        <div class="order-row">
                            <div class="table-box"><div class="table-text ${isB ? 'booth' : ''}">${isB ? 'ğŸ’åŒ…å»‚' : o.table + 'æ¡Œ'}</div></div>
                            <div class="items-box"><div class="item-detail">${(o.items || []).join('ã€')}</div></div>
                            <div class="action-box">
                                <div class="price-text">$${o.total}</div>
                                <button class="btn-base btn-pay ${isPaid ? 'done' : ''}" onclick="${isPaid ? '' : `payOrder('${id}')`}">
                                    ${isPaid ? 'âœ“ å·²çµå¸³' : 'å°šæœªçµå¸³'}
                                </button>
                                <button class="btn-base btn-ship" onclick="shipOrder('${id}')">å·²å‡ºé¤</button>
                            </div>
                        </div>` + listBox.innerHTML;
                }
            }
        });

        if (knownOrderIds === null) { knownOrderIds = currentIds; } 
        else {
            if (shouldSpeak && isSystemReady) {
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(new SpeechSynthesisUtterance("æ‚¨æœ‰æ–°è¨‚å–®"));
            }
            knownOrderIds = currentIds;
        }
        document.getElementById('rev-val').innerText = "$" + todaySum.toLocaleString();
    });

    function payOrder(id) {
        db.ref('orders/' + id).update({ payStatus: "å·²çµå¸³" });
    }

    function shipOrder(id) {
        db.ref('orders/' + id).update({ status: "å·²å‡ºé¤" });
    }
</script>
</body>
</html>