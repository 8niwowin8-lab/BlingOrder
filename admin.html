<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlingOrder | å…¨èƒ½ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-pink: #ff85a2; --soft-pink: #fffafa; }
        body { font-family: "PingFang TC", sans-serif; background: var(--soft-pink); margin: 0; padding: 20px; }
        .admin-header { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #fff0f3; }
        .admin-title { font-size: 22px; font-weight: bold; color: var(--primary-pink); margin: 0; }
        .revenue-box { background: var(--primary-pink); color: white; padding: 12px 25px; border-radius: 15px; text-align: right; }
        .rev-val { font-size: 24px; font-weight: 800; }
        
        /* è¨‚å–®å¡ç‰‡æ¨£å¼ */
        .order-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 8px solid var(--primary-pink); position: relative; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .table-num { font-size: 20px; font-weight: bold; color: #333; }
        .order-time { font-size: 13px; color: #999; }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-list li { padding: 5px 0; color: #444; font-size: 16px; border-bottom: 1px dashed #f5f5f5; }
        .order-footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; }
        .total-price { font-weight: 800; color: var(--primary-pink); font-size: 18px; }
        .btn-finish { background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .nav-bar { margin-bottom: 20px; display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .nav-link { background: white; padding: 10px 15px; border-radius: 10px; text-decoration: none; color: #666; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap; }
    </style>
</head>
<body>

<div class="admin-header">
    <div>
        <h1 class="admin-title">ğŸ€ è¨‚å–®ç®¡ç†ç³»çµ±</h1>
        <p id="today-date-label" style="margin:2px 0; color:#aaa; font-size:12px; font-weight:bold;"></p>
    </div>
    <div class="revenue-box">
        <div style="font-size:12px; opacity:0.9;">ä»Šæ—¥ç‡Ÿæ”¶</div>
        <div class="rev-val" id="admin-today-rev">$0</div>
    </div>
</div>

<div class="nav-bar">
    <a href="menu-admin.html" class="nav-link">ğŸ” èœå–®</a>
    <a href="report.html" class="nav-link">ğŸ“Š å ±è¡¨</a>
    <a href="dashboard.html" class="nav-link">ğŸ“ˆ åˆ†æ</a>
    <button onclick="enableVoice()" id="voice-btn" style="background:#e3f2fd; color:#1976d2; border:1px solid #bbdefb; border-radius:10px; padding:10px; font-weight:bold;">é–‹å•ŸèªéŸ³æé†’</button>
</div>

<div class="order-container" id="order-list">
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTeLTAX-F5i3WHKYY0ITZsla0Qgs5e2zQ",
        authDomain: "blingorder.firebaseapp.com",
        projectId: "blingorder",
        databaseURL: "https://blingorder-default-rtdb.firebaseio.com",
        appId: "1:798993901664:web:9c2023b419ae099fe9fb05"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let lastOrderCount = -1;
    let isVoiceEnabled = false;

    // å•Ÿå‹•èªéŸ³åŠŸèƒ½ (ç€è¦½å™¨è¦å®šå¿…é ˆç”±ä½¿ç”¨è€…é»æ“Šå¾Œæ‰èƒ½å‡ºè²)
    function enableVoice() {
        isVoiceEnabled = true;
        document.getElementById('voice-btn').innerText = "ğŸ”Š èªéŸ³å·²é–‹å•Ÿ";
        document.getElementById('voice-btn').style.background = "#c8e6c9";
        const msg = new SpeechSynthesisUtterance("èªéŸ³æé†’åŠŸèƒ½å·²å•Ÿå‹•");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    function speakOrder(tableName) {
        if (!isVoiceEnabled) return;
        const msg = new SpeechSynthesisUtterance(`æ‚¨æœ‰ä¾†è‡ª${tableName}çš„æ–°è¨‚å–®`);
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    const todayStr = new Date().toLocaleDateString('zh-TW');
    document.getElementById('today-date-label').innerText = `åŸºæº–æ—¥ï¼š${todayStr}`;

    db.ref('orders').on('value', snap => {
        let todaySum = 0;
        const container = document.getElementById('order-list');
        container.innerHTML = "";
        
        let currentOrders = [];
        snap.forEach(child => {
            const o = child.val();
            o.id = child.key;
            const orderDate = new Date(parseInt(o.timestamp || o.id)).toLocaleDateString('zh-TW');

            // çµ±è¨ˆç‡Ÿæ”¶
            if (orderDate === todayStr) {
                todaySum += parseInt(o.total || 0);
            }

            // åªé¡¯ç¤ºã€Œæœªçµå¸³ã€æˆ–ã€Œå¾…è™•ç†ã€çš„è¨‚å–®
            if (o.status !== "å·²çµå¸³") {
                currentOrders.unshift(o); // æ–°å–®æ’å‰é¢
            }
        });

        // èªéŸ³æé†’åˆ¤å®š
        if (lastOrderCount !== -1 && currentOrders.length > lastOrderCount) {
            const newestOrder = currentOrders[0];
            speakOrder(newestOrder.table);
        }
        lastOrderCount = currentOrders.length;

        // æ¸²æŸ“è¨‚å–®å¡ç‰‡
        currentOrders.forEach(o => {
            const timeStr = new Date(parseInt(o.timestamp || o.id)).toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
            const tableDisplay = o.table === "åŒ…å»‚" ? "âœ¨ åŒ…å»‚" : `ç¬¬ ${o.table} æ¡Œ`;
            
            let itemsHtml = (o.items || []).map(i => `<li>${i}</li>`).join('');
            
            container.innerHTML += `
                <div class="order-card">
                    <div class="order-header">
                        <span class="table-num">${tableDisplay}</span>
                        <span class="order-time">${timeStr}</span>
                    </div>
                    <ul class="item-list">${itemsHtml}</ul>
                    <div class="order-footer">
                        <span class="total-price">$${o.total}</span>
                        <button class="btn-finish" onclick="completeOrder('${o.id}')">å®Œæˆ/çµå¸³</button>
                    </div>
                </div>`;
        });

        document.getElementById('admin-today-rev').innerText = `$${todaySum.toLocaleString()}`;
    });

    function completeOrder(id) {
        if(confirm("ç¢ºå®šæ­¤è¨‚å–®å·²å®Œæˆçµå¸³ä¸¦é€é¤ï¼Ÿ")) {
            db.ref('orders/' + id).update({ status: "å·²çµå¸³" });
        }
    }
</script>
</body>
</html>